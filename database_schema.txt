
-- 1. Tabel Cabang
CREATE TABLE IF NOT EXISTS branches (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    address TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

INSERT INTO branches (id, name, address) 
VALUES ('pusat', 'Bakso Ujo Pusat', 'Jl. Spesial No. 1')
ON CONFLICT (id) DO NOTHING;

-- 2. Tabel Profil Kedai
CREATE TABLE IF NOT EXISTS store_profiles (
    id BIGSERIAL PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    address TEXT,
    slogan TEXT,
    logo TEXT,
    theme_color TEXT DEFAULT 'orange',
    tax_rate DECIMAL DEFAULT 0,
    enable_tax BOOLEAN DEFAULT false,
    service_charge_rate DECIMAL DEFAULT 0,
    enable_service_charge BOOLEAN DEFAULT false,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 3. Tabel Kategori Menu
CREATE TABLE IF NOT EXISTS categories (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);

INSERT INTO categories (name) VALUES ('Bakso'), ('Mie Ayam'), ('Minuman'), ('Tambahan') ON CONFLICT DO NOTHING;

-- 4. Tabel Menu / Produk
CREATE TABLE IF NOT EXISTS products (
    id BIGINT PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    price DECIMAL NOT NULL,
    category TEXT,
    image_url TEXT,
    stock INTEGER DEFAULT NULL,
    min_stock INTEGER DEFAULT 5,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 5. Tabel User / Karyawan
CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    pin TEXT NOT NULL,
    attendance_pin TEXT,
    role TEXT NOT NULL DEFAULT 'staff',
    department TEXT DEFAULT 'Operasional',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

INSERT INTO users (id, branch_id, name, pin, attendance_pin, role, department) 
VALUES ('admin-1', 'pusat', 'Owner / Admin', '1234', '1111', 'admin', 'Management')
ON CONFLICT (id) DO NOTHING;

-- 6. Tabel Shift
CREATE TABLE IF NOT EXISTS shifts (
    id TEXT PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    start_time BIGINT NOT NULL,
    end_time BIGINT,
    start_cash DECIMAL DEFAULT 0,
    closing_cash DECIMAL,
    revenue DECIMAL DEFAULT 0,
    cash_revenue DECIMAL DEFAULT 0,
    non_cash_revenue DECIMAL DEFAULT 0,
    total_discount DECIMAL DEFAULT 0,
    created_by TEXT REFERENCES users(id)
);

-- 7. Tabel Pesanan (Orders)
CREATE TABLE IF NOT EXISTS orders (
    id TEXT PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    shift_id TEXT REFERENCES shifts(id),
    customer_name TEXT,
    items JSONB NOT NULL,
    total DECIMAL NOT NULL,
    discount DECIMAL DEFAULT 0,
    status TEXT DEFAULT 'pending',
    is_paid BOOLEAN DEFAULT false,
    payment_method TEXT,
    order_type TEXT DEFAULT 'Dine In',
    created_at BIGINT NOT NULL,
    paid_at BIGINT,
    sequential_id BIGSERIAL,
    order_source TEXT DEFAULT 'admin'
);

-- Tabel Detail Pesanan
CREATE TABLE IF NOT EXISTS order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id TEXT REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT,
    product_name TEXT NOT NULL,
    price DECIMAL NOT NULL,
    quantity INTEGER NOT NULL,
    note TEXT
);

-- 8. Tabel Pengeluaran
CREATE TABLE IF NOT EXISTS expenses (
    id BIGSERIAL PRIMARY KEY,
    shift_id TEXT REFERENCES shifts(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    amount DECIMAL NOT NULL,
    created_at BIGINT NOT NULL
);

-- 9. Tabel Meja
CREATE TABLE IF NOT EXISTS tables (
    id TEXT PRIMARY KEY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    table_number TEXT NOT NULL,
    qr_payload TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 10. Tabel Absensi (Updated with Monitoring Fields)
CREATE TABLE IF NOT EXISTS attendance (
    id TEXT PRIMARY KEY,
    user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
    user_name TEXT NOT NULL,
    department TEXT DEFAULT 'Operasional',
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE,
    date TEXT NOT NULL,
    clock_in BIGINT NOT NULL,
    clock_out BIGINT,
    status TEXT DEFAULT 'Hadir', -- Hadir, Terlambat, Izin, Sakit, Pulang Awal
    photo_url TEXT,
    lat NUMERIC,
    lng NUMERIC,
    location_name TEXT,
    distance_meters NUMERIC,
    is_within_radius BOOLEAN DEFAULT true,
    ip_address TEXT,
    device_info TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 11. Tabel Pengaturan Kantor (Geo-fencing & Hours)
CREATE TABLE IF NOT EXISTS office_settings (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id TEXT REFERENCES branches(id) ON DELETE CASCADE UNIQUE,
    office_name TEXT NOT NULL,
    latitude FLOAT8 NOT NULL,
    longitude FLOAT8 NOT NULL,
    radius_km FLOAT8 DEFAULT 0.05, -- Default 50 meter
    start_time TIME NOT NULL DEFAULT '08:00:00',
    end_time TIME NOT NULL DEFAULT '17:00:00'
);

-- PENTING: DISABLE RLS AGAR APLIKASI BISA AKSES TANPA ERROR 401/403
ALTER TABLE branches DISABLE ROW LEVEL SECURITY;
ALTER TABLE store_profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE categories DISABLE ROW LEVEL SECURITY;
ALTER TABLE products DISABLE ROW LEVEL SECURITY;
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE shifts DISABLE ROW LEVEL SECURITY;
ALTER TABLE orders DISABLE ROW LEVEL SECURITY;
ALTER TABLE order_items DISABLE ROW LEVEL SECURITY;
ALTER TABLE expenses DISABLE ROW LEVEL SECURITY;
ALTER TABLE tables DISABLE ROW LEVEL SECURITY;
ALTER TABLE attendance DISABLE ROW LEVEL SECURITY;
ALTER TABLE office_settings DISABLE ROW LEVEL SECURITY;

-- 12. KONFIGURASI STORAGE
CREATE POLICY "Public Access" ON storage.objects FOR SELECT USING (bucket_id = 'BAKSOUJOPOS');
CREATE POLICY "Public Upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'BAKSOUJOPOS');
CREATE POLICY "Public Update" ON storage.objects FOR UPDATE USING (bucket_id = 'BAKSOUJOPOS');

-- Tambahkan Index
CREATE INDEX IF NOT EXISTS idx_products_branch ON products(branch_id);
CREATE INDEX IF NOT EXISTS idx_orders_branch ON orders(branch_id);
CREATE INDEX IF NOT EXISTS idx_users_pin ON users(pin);
CREATE INDEX IF NOT EXISTS idx_attendance_user ON attendance(user_id);
CREATE INDEX IF NOT EXISTS idx_attendance_date ON attendance(date);
